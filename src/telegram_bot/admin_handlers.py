"""
Handler Ù‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… - Fixed Version
"""
import re
import requests
import urllib.parse
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler
from sqlalchemy.orm import Session
from typing import List, Dict, Optional
from bs4 import BeautifulSoup

from src.database.database import db_session
from src.database.models import User, Doctor, Subscription
from src.telegram_bot.messages import MessageFormatter
from src.utils.logger import get_logger
from src.utils.config import Config

logger = get_logger("TelegramAdminHandlers")

# States Ø¨Ø±Ø§ÛŒ ConversationHandler
ADD_DOCTOR_LINK, ADD_DOCTOR_CONFIRM, SET_CHECK_INTERVAL = range(3)


class TelegramAdminHandlers:
    """Ú©Ù„Ø§Ø³ handler Ù‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† ØªÙ„Ú¯Ø±Ø§Ù…"""
    
    @staticmethod
    def is_admin(user_id: int) -> bool:
        """Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯"""
        try:
            from src.telegram_bot.user_roles import user_role_manager
            return user_role_manager.is_admin_or_higher(user_id)
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†: {e}")
            return False
    
    @staticmethod
    async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†"""
        try:
            user_id = update.effective_user.id
            logger.info(f"Admin panel request from user: {user_id}")
            
            if not TelegramAdminHandlers.is_admin(user_id):
                await update.message.reply_text("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯.")
                return
            
            keyboard = [
                [InlineKeyboardButton("â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©ØªØ±", callback_data="admin_add_doctor")],
                [InlineKeyboardButton("ğŸ”§ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©ØªØ±Ù‡Ø§", callback_data="admin_manage_doctors")],
                [InlineKeyboardButton("â±ï¸ ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ", callback_data="admin_set_interval")],
                [InlineKeyboardButton("ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†", callback_data="admin_manage_users")],
                [InlineKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…", callback_data="admin_stats")],
                [InlineKeyboardButton("ğŸ”’ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ", callback_data="admin_access_settings")]
            ]
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            admin_text = "ğŸ”§ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª P24_SlotHunter\n\nØ§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
            
            await update.message.reply_text(admin_text, reply_markup=reply_markup)
            logger.info("Admin panel sent successfully")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†: {e}")
            await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª.")
    
    @staticmethod
    async def start_add_doctor(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©ØªØ±"""
        query = update.callback_query
        await query.answer()
        
        if not TelegramAdminHandlers.is_admin(query.from_user.id):
            await query.edit_message_text("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯.")
            return ConversationHandler.END
        
        await query.edit_message_text(
            "ğŸ”— Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©ØªØ± Ø¬Ø¯ÛŒØ¯\n\n"
            "Ù„ÛŒÙ†Ú© ØµÙØ­Ù‡ Ø¯Ú©ØªØ± Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´Û²Û´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
            "âœ… ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡:\n"
            "â€¢ https://www.paziresh24.com/dr/Ø¯Ú©ØªØ±-Ù†Ø§Ù…-0/\n"
            "â€¢ https://www.paziresh24.com/dr/%D8%AF%DA%A9%D8%AA%D8%B1-...\n\n"
            "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ: /cancel"
        )
        
        return ADD_DOCTOR_LINK
    
    @staticmethod
    async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù„ØºÙˆ Ù…Ú©Ø§Ù„Ù…Ù‡"""
        await update.message.reply_text(
            "âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.\n\n"
            "ğŸ”„ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª: /admin"
        )
        return ConversationHandler.END