#!/usr/bin/env python3
"""
ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ P24_SlotHunter
"""
import asyncio
import signal
import sys
from pathlib import Path

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± src Ø¨Ù‡ Python path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.utils.config import Config
from src.utils.logger import setup_logger
from src.api.paziresh_client import PazireshAPI


class SlotHunter:
    """Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ Ù†ÙˆØ¨Øªâ€ŒÛŒØ§Ø¨"""
    
    def __init__(self):
        self.config = Config()
        self.logger = setup_logger(
            level=self.config.log_level,
            log_file=self.config.log_file
        )
        self.running = False
        
    async def start(self):
        """Ø´Ø±ÙˆØ¹ Ù†ÙˆØ¨Øªâ€ŒÛŒØ§Ø¨"""
        self.logger.info("ğŸš€ Ø´Ø±ÙˆØ¹ P24_SlotHunter")
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        if not self.config.telegram_bot_token:
            self.logger.error("âŒ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")
            return
        
        doctors = self.config.get_doctors()
        if not doctors:
            self.logger.error("âŒ Ù‡ÛŒÚ† Ø¯Ú©ØªØ±ÛŒ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯")
            return
        
        self.logger.info(f"ğŸ‘¨â€âš•ï¸ {len(doctors)} Ø¯Ú©ØªØ± Ø¯Ø± Ø­Ø§Ù„ Ù†Ø¸Ø§Ø±Øª:")
        for doctor in doctors:
            if doctor.is_active:
                self.logger.info(f"  âœ… {doctor.name} - {doctor.specialty}")
            else:
                self.logger.info(f"  â¸ï¸ {doctor.name} - ØºÛŒØ±ÙØ¹Ø§Ù„")
        
        self.running = True
        
        # Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Ù†Ø¸Ø§Ø±Øª
        await self.monitor_loop()
    
    async def monitor_loop(self):
        """Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Ù†Ø¸Ø§Ø±Øª"""
        active_doctors = [d for d in self.config.get_doctors() if d.is_active]
        
        while self.running:
            try:
                self.logger.info("ğŸ” Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ...")
                
                # Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ù‡ Ø¯Ú©ØªØ±Ù‡Ø§
                for doctor in active_doctors:
                    await self.check_doctor(doctor)
                
                # ØµØ¨Ø± ØªØ§ Ø¯ÙˆØ± Ø¨Ø¹Ø¯ÛŒ
                self.logger.info(f"â° ØµØ¨Ø± {self.config.check_interval} Ø«Ø§Ù†ÛŒÙ‡ ØªØ§ Ø¯ÙˆØ± Ø¨Ø¹Ø¯ÛŒ...")
                await asyncio.sleep(self.config.check_interval)
                
            except KeyboardInterrupt:
                self.logger.info("â¹ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªÙˆÙ‚Ù...")
                break
            except Exception as e:
                self.logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ù†Ø¸Ø§Ø±Øª: {e}")
                await asyncio.sleep(60)  # ØµØ¨Ø± Ø¨ÛŒØ´ØªØ± Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
    
    async def check_doctor(self, doctor):
        """Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ© Ø¯Ú©ØªØ±"""
        try:
            api = PazireshAPI(doctor, timeout=self.config.api_timeout)
            appointments = api.get_available_appointments(days_ahead=self.config.days_ahead)
            
            if appointments:
                self.logger.info(f"ğŸ¯ {len(appointments)} Ù†ÙˆØ¨Øª Ø¨Ø±Ø§ÛŒ {doctor.name} Ù¾ÛŒØ¯Ø§ Ø´Ø¯!")
                
                # Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
                await self.notify_appointments(doctor, appointments)
            else:
                self.logger.debug(f"ğŸ“… Ù‡ÛŒÚ† Ù†ÙˆØ¨ØªÛŒ Ø¨Ø±Ø§ÛŒ {doctor.name} Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª")
                
        except Exception as e:
            self.logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ {doctor.name}: {e}")
    
    async def notify_appointments(self, doctor, appointments):
        """Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯"""
        # TODO: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª ï¿½ï¿½Ù„Ú¯Ø±Ø§Ù…
        self.logger.info(f"ğŸ“¢ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ {len(appointments)} Ù†ÙˆØ¨Øª Ø¨Ø±Ø§ÛŒ {doctor.name}")
        
        # Ù†Ù…Ø§ÛŒØ´ Ú†Ù†Ø¯ Ù†ÙˆØ¨Øª Ø§ÙˆÙ„
        for apt in appointments[:3]:
            self.logger.info(f"  â° {apt.time_str}")
    
    def stop(self):
        """ØªÙˆÙ‚Ù Ù†ÙˆØ¨Øªâ€ŒÛŒØ§Ø¨"""
        self.logger.info("ğŸ›‘ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù...")
        self.running = False


def signal_handler(signum, frame):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…"""
    print("\nğŸ›‘ Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªÙˆÙ‚Ù...")
    sys.exit(0)


async def main():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ"""
    # ØªÙ†Ø¸ÛŒÙ… signal handlers
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    # Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ù†ÙˆØ¨Øªâ€ŒÛŒØ§Ø¨
    hunter = SlotHunter()
    try:
        await hunter.start()
    except KeyboardInterrupt:
        hunter.stop()
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: {e}")


if __name__ == "__main__":
    asyncio.run(main())